
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Discrepencies with GaussianProcessorRegressor: use of double &#8212; sklearn-onnx 1.9.1.dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/readable.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-rendered-html.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Errors with onnxruntime" href="plot_errors_onnxruntime.html" />
    <link rel="prev" title="Custom Operator for NMF Decomposition" href="plot_nmf.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="plot_errors_onnxruntime.html" title="Errors with onnxruntime"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plot_nmf.html" title="Custom Operator for NMF Decomposition"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">sklearn-onnx 1.9.1.dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Gallery of examples</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Discrepencies with GaussianProcessorRegressor: use of double</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-examples-plot-gpr-py"><span class="std std-ref">here</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="discrepencies-with-gaussianprocessorregressor-use-of-double">
<span id="l-gpr-example"></span><span id="sphx-glr-auto-examples-plot-gpr-py"></span><h1>Discrepencies with GaussianProcessorRegressor: use of double<a class="headerlink" href="#discrepencies-with-gaussianprocessorregressor-use-of-double" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.gaussian_process.GaussianProcessRegressor.html">GaussianProcessRegressor</a> involves
many matrix operations which may requires double
precisions. <em>sklearn-onnx</em> is using single floats by default
but for this particular model, it is better to use double.
Let’s see how to create an ONNX file using doubles.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#train-a-model" id="id2">Train a model</a></p></li>
<li><p><a class="reference internal" href="#first-attempt-to-convert-a-model-into-onnx" id="id3">First attempt to convert a model into ONNX</a></p></li>
<li><p><a class="reference internal" href="#second-attempt-variable-dimensions" id="id4">Second attempt: variable dimensions</a></p></li>
<li><p><a class="reference internal" href="#third-attempt-use-of-double" id="id5">Third attempt: use of double</a></p></li>
<li><p><a class="reference internal" href="#size-increase" id="id6">Size increase</a></p></li>
<li><p><a class="reference internal" href="#return-std-true" id="id7">return_std=True</a></p></li>
</ul>
</div>
<section id="train-a-model">
<h2><a class="toc-backref" href="#id2">Train a model</a><a class="headerlink" href="#train-a-model" title="Permalink to this headline">¶</a></h2>
<p>A very basic example using <em>GaussianProcessRegressor</em>
on the Boston dataset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_boston</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">DotProduct</span><span class="p">,</span> <span class="n">RBF</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">import</span> <span class="nn">onnx</span>
<span class="kn">import</span> <span class="nn">onnxruntime</span> <span class="k">as</span> <span class="nn">rt</span>
<span class="kn">import</span> <span class="nn">skl2onnx</span>
<span class="kn">from</span> <span class="nn">skl2onnx.common.data_types</span> <span class="kn">import</span> <span class="n">FloatTensorType</span><span class="p">,</span> <span class="n">DoubleTensorType</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">convert_sklearn</span>

<span class="n">bost</span> <span class="o">=</span> <span class="n">load_boston</span><span class="p">()</span>
<span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">bost</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">bost</span><span class="o">.</span><span class="n">target</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">gpr</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">DotProduct</span><span class="p">()</span> <span class="o">+</span> <span class="n">RBF</span><span class="p">(),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
<span class="n">gpr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gpr</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>GaussianProcessRegressor(alpha=1.0,
                         kernel=DotProduct(sigma_0=1) + RBF(length_scale=1))
</pre></div>
</div>
</section>
<section id="first-attempt-to-convert-a-model-into-onnx">
<h2><a class="toc-backref" href="#id3">First attempt to convert a model into ONNX</a><a class="headerlink" href="#first-attempt-to-convert-a-model-into-onnx" title="Permalink to this headline">¶</a></h2>
<p>The documentation suggests the following way to
convert a model into ONNX.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initial_type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))]</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">,</span>
                      <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">pred_onx</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="mi">0</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="second-attempt-variable-dimensions">
<h2><a class="toc-backref" href="#id4">Second attempt: variable dimensions</a><a class="headerlink" href="#second-attempt-variable-dimensions" title="Permalink to this headline">¶</a></h2>
<p>Unfortunately, even though the conversion
went well, the runtime fails to compute the prediction.
The previous snippet of code imposes fixed dimension
on the input and therefore let the runtime assume
every node output has outputs with fixed dimensions
And that’s not the case for this model.
We need to disable these checkings by replacing
the fixed dimensions by an empty value.
(see next line).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initial_type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">FloatTensorType</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))]</span>
<span class="n">onx</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">,</span>
                      <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">pred_onx</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)})[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">pred_skl</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_skl</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pred_onx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[ 8.47279037 21.51262113 21.01745402 22.41744577 18.19772241 10.81804541
 19.04764201 19.05131637 13.59718983 22.83375467]
[9.8125]
</pre></div>
</div>
<p>The differences seems quite important.
Let’s confirm that by looking at the biggest
differences.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_skl</span><span class="p">)</span> <span class="o">-</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_onx</span><span class="p">)))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min(Y)-max(Y):&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[3.48977759 3.52570373 3.53529477 3.7294376  3.95012113]
min(Y)-max(Y): 7.0 50.0
</pre></div>
</div>
</section>
<section id="third-attempt-use-of-double">
<h2><a class="toc-backref" href="#id5">Third attempt: use of double</a><a class="headerlink" href="#third-attempt-use-of-double" title="Permalink to this headline">¶</a></h2>
<p>The model uses a couple of matrix computations
and matrices have coefficients with very different
order of magnitude. It is difficult to approximate
the prediction made with scikit-learn if the converted
model sticks to float. Double precision is needed.</p>
<p>The previous code requires two changes. The first
one indicates that inputs are now of type
<code class="docutils literal notranslate"><span class="pre">DoubleTensorType</span></code>. The second change
is the extra parameter <code class="docutils literal notranslate"><span class="pre">dtype=numpy.float64</span></code>
tells the conversion function that every real
constant matrix such as the trained coefficients
will be dumped as doubles and not as floats anymore.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initial_type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">DoubleTensorType</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))]</span>
<span class="n">onx64</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">,</span>
                        <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">sess64</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx64</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">pred_onx64</span> <span class="o">=</span> <span class="n">sess64</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})[</span><span class="mi">0</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">pred_onx64</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:</span><span class="mi">10</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[8.47279038]
</pre></div>
</div>
<p>The new differences look much better.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_skl</span><span class="p">)</span> <span class="o">-</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_onx64</span><span class="p">)))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min(Y)-max(Y):&#39;</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_test</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_test</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[1.40515830e-08 1.41196868e-08 1.45794949e-08 1.78195023e-08
 2.33744597e-08]
min(Y)-max(Y): 7.0 50.0
</pre></div>
</div>
</section>
<section id="size-increase">
<h2><a class="toc-backref" href="#id6">Size increase</a><a class="headerlink" href="#size-increase" title="Permalink to this headline">¶</a></h2>
<p>As a result, the ONNX model is almost twice bigger
because every coefficient is stored as double and
and not as floats anymore.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">size32</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">onx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">size64</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">onx64</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ONNX with floats:&quot;</span><span class="p">,</span> <span class="n">size32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ONNX with doubles:&quot;</span><span class="p">,</span> <span class="n">size64</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>ONNX with floats: 42817
ONNX with doubles: 83821
</pre></div>
</div>
</section>
<section id="return-std-true">
<h2><a class="toc-backref" href="#id7">return_std=True</a><a class="headerlink" href="#return-std-true" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.gaussian_process.GaussianProcessRegressor.html">GaussianProcessRegressor</a>
is one model which defined additional parameter to the predict function.
If call with <code class="docutils literal notranslate"><span class="pre">return_std=True</span></code>, the class returns one more results
and that needs to be reflected into the generated ONNX graph.
The converter needs to know that an extended graph is required.
That’s done through the option mechanism
(see <a class="reference internal" href="../parameterized.html#l-conv-options"><span class="std std-ref">Converters with options</span></a>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">initial_type</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">DoubleTensorType</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]))]</span>
<span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">GaussianProcessRegressor</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;return_std&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}}</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">onx64_std</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">,</span>
                                <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>This error highlights the fact that the <em>scikit-learn</em>
computes internal variables on first call to method predict.
The converter needs them to be initialized by calling method
predict at least once and then converting again.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">onx64_std</span> <span class="o">=</span> <span class="n">convert_sklearn</span><span class="p">(</span><span class="n">gpr</span><span class="p">,</span> <span class="n">initial_types</span><span class="o">=</span><span class="n">initial_type</span><span class="p">,</span>
                            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="n">sess64_std</span> <span class="o">=</span> <span class="n">rt</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">onx64_std</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
<span class="n">pred_onx64_std</span> <span class="o">=</span> <span class="n">sess64_std</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]})</span>

<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">pred_onx64_std</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[array([[ 8.47279038],
       [21.51262113],
       [21.01745401],
       [22.41744575],
       [18.19772242]]),
 array([1.12532655, 0.98897694, 1.02265588, 0.79327986, 1.44545271])]
</pre></div>
</div>
<p>Let’s compare with <em>scikit-learn</em> prediction.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(array([ 8.47279037, 21.51262113, 21.01745402, 22.41744577, 18.19772241]),
 array([1.12467067, 0.98900305, 1.02235072, 0.79310697, 1.44517277]))
</pre></div>
</div>
<p>It looks good. Let’s do a better checks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pred_onx64_std</span> <span class="o">=</span> <span class="n">sess64_std</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">X_test</span><span class="p">})</span>
<span class="n">pred_std</span> <span class="o">=</span> <span class="n">gpr</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">diff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_onx64_std</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span>
                            <span class="n">numpy</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">pred_std</span><span class="p">[</span><span class="mi">1</span><span class="p">])))[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[0.00083071 0.00104528 0.00104868 0.00121139 0.00122756]
</pre></div>
</div>
<p>There are some discrepencies but it seems reasonable.</p>
<p><strong>Versions used for this example</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;numpy:&quot;</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scikit-learn:&quot;</span><span class="p">,</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnx: &quot;</span><span class="p">,</span> <span class="n">onnx</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onnxruntime: &quot;</span><span class="p">,</span> <span class="n">rt</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skl2onnx: &quot;</span><span class="p">,</span> <span class="n">skl2onnx</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>numpy: 1.21.0
scikit-learn: 0.24.2
onnx:  1.9.0
onnxruntime:  1.8.0
skl2onnx:  1.9.1.dev
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  1.039 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-plot-gpr-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/onnx/sklearn-onnx/master?filepath=notebooks/auto_examples/plot_gpr.ipynb"><img alt="Launch binder" src="../_images/binder_badge_logo.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/3198a363670952cab4b00c49b36e6422/plot_gpr.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_gpr.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/aed99bc8ade3f0f8a99b9ca3cc28d31e/plot_gpr.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_gpr.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_main.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Discrepencies with GaussianProcessorRegressor: use of double</a><ul>
<li><a class="reference internal" href="#train-a-model">Train a model</a></li>
<li><a class="reference internal" href="#first-attempt-to-convert-a-model-into-onnx">First attempt to convert a model into ONNX</a></li>
<li><a class="reference internal" href="#second-attempt-variable-dimensions">Second attempt: variable dimensions</a></li>
<li><a class="reference internal" href="#third-attempt-use-of-double">Third attempt: use of double</a></li>
<li><a class="reference internal" href="#size-increase">Size increase</a></li>
<li><a class="reference internal" href="#return-std-true">return_std=True</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation index</a><ul>
  <li><a href="index.html">Gallery of examples</a><ul>
      <li>Previous: <a href="plot_nmf.html" title="previous chapter">Custom Operator for NMF Decomposition</a></li>
      <li>Next: <a href="plot_errors_onnxruntime.html" title="next chapter">Errors with onnxruntime</a></li>
  </ul></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/auto_examples/plot_gpr.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2018-2021, Microsoft.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.0.
  </div>
  
  </body>
</html>