
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Fast design with a python runtime &#8212; sklearn-onnx 1.11.1 documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Fast runtime with onnxruntime" href="plot_qextend_onnxruntime.html" />
    <link rel="prev" title="Extend ONNX, extend runtime" href="../tutorial_3_new_operator.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../index.html">
  <img src="../_static/logo_main.png" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../introduction.html">
  Introduction
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../index_tutorial.html">
  Tutorial
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api_summary.html">
  API Summary
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../auto_examples/index.html">
  Gallery of examples
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../pipeline.html">
  Convert a pipeline
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../parameterized.html">
  Converters with options
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../supported.html">
  Supported scikit-learn Models
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar">
              <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial_1_simple.html">
   The easy case
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_abegin_convert_pipeline.html">
     Train and deploy a scikit-learn pipeline
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_bbegin_measure_time.html">
     Benchmark ONNX conversion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_cbegin_opset.html">
     What is the opset number?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_dbegin_options.html">
     One model, many possible conversions with options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_dbegin_options_zipmap.html">
     Choose appropriate output of a classifier
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_dbegin_options_list.html">
     Black list operators when converting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_ebegin_float_double.html">
     Issues when switching to float
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_fbegin_investigate.html">
     Intermediate results and investigation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gbegin_cst.html">
     Store arrays in one onnx graph
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gbegin_dataframe.html">
     Dataframe as an input
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gconverting.html">
     Modify the ONNX graph
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gbegin_transfer_learning.html">
     Transfer Learning with ONNX
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial_1-5_external.html">
   Using converters from other libraries
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gexternal_lightgbm.html">
     Convert a pipeline with a LightGBM classifier
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gexternal_lightgbm_reg.html">
     Convert a pipeline with a LightGBM regressor
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_gexternal_xgboost.html">
     Convert a pipeline with a XGBoost model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial_2_new_converter.html">
   A custom converter for a custom model
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_icustom_converter.html">
     Implement a new converter
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_jcustom_syntax.html">
     Two ways to implement a converter
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_kcustom_converter_wrapper.html">
     Implement a new converter using other converters
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_lcustom_options.html">
     A new converter with options
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_mcustom_parser.html">
     Change the number of outputs by adding a parser
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../tutorial_3_new_operator.html">
   Extend ONNX, extend runtime
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Fast design with a python runtime
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_qextend_onnxruntime.html">
     Fast runtime with onnxruntime
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial_4_advanced.html">
   Advanced scenarios
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_usparse_xgboost.html">
     TfIdf and sparse matrices
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_woe_transformer.html">
     Converter for WOE
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial_2-5_extlib.html">
   Write converters for other libraries
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="plot_wext_pyod_forest.html">
     Converter for pyod.models.iforest.IForest
    </a>
   </li>
  </ul>
 </li>
</ul>

  </div>
</nav>
              </div>
              <div class="sidebar-end-items">
              </div>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#a-transformer-which-decorrelates-variables">
   A transformer which decorrelates variables
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extend-onnx">
   Extend ONNX
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#new-onnx-operator">
     New ONNX operator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#shape-calculator">
     shape calculator
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#converter">
     converter
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#runtime-for-eig">
     Runtime for Eig
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#registration">
     Registration
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-example">
   Final example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#final-graph">
   Final graph
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                
              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-tutorial-plot-pextend-python-runtime-py"><span class="std std-ref">here</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="fast-design-with-a-python-runtime">
<span id="l-extend-python-runtime"></span><span id="sphx-glr-auto-tutorial-plot-pextend-python-runtime-py"></span><h1>Fast design with a python runtime<a class="headerlink" href="#fast-design-with-a-python-runtime" title="Permalink to this headline">#</a></h1>
<p id="index-0"><a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX operators</a> do not contain all operators
from <a class="reference external" href="https://numpy.org/">numpy</a>. There is no operator for
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.solve.html">solve</a> but this one
is needed to implement the prediction function
of model <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.decomposition.NMF.html">NMF</a>. The converter can be written
including a new ONNX operator but then it requires a
runtime for it to be tested. This example shows how
to do that with the python runtime implemented in
<a class="reference external" href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/index.html">mlprodict</a>. It may not be <a class="reference external" href="https://microsoft.github.io/onnxruntime/">onnxruntime</a>
but that speeds up the implementation of the converter.</p>
<p>The example changes the transformer from
<a class="reference internal" href="plot_icustom_converter.html#l-plot-custom-converter"><span class="std std-ref">Implement a new converter</span></a>, the method <em>predict</em>
decorrelates the variables by computing the eigen
values. Method <em>fit</em> does not do anything anymore.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#a-transformer-which-decorrelates-variables" id="id1">A transformer which decorrelates variables</a></p></li>
<li><p><a class="reference internal" href="#extend-onnx" id="id2">Extend ONNX</a></p>
<ul>
<li><p><a class="reference internal" href="#new-onnx-operator" id="id3">New ONNX operator</a></p></li>
<li><p><a class="reference internal" href="#shape-calculator" id="id4">shape calculator</a></p></li>
<li><p><a class="reference internal" href="#converter" id="id5">converter</a></p></li>
<li><p><a class="reference internal" href="#runtime-for-eig" id="id6">Runtime for Eig</a></p></li>
<li><p><a class="reference internal" href="#registration" id="id7">Registration</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#final-example" id="id8">Final example</a></p></li>
<li><p><a class="reference internal" href="#final-graph" id="id9">Final graph</a></p></li>
</ul>
</div>
<section id="a-transformer-which-decorrelates-variables">
<h2><a class="toc-backref" href="#id1">A transformer which decorrelates variables</a><a class="headerlink" href="#a-transformer-which-decorrelates-variables" title="Permalink to this headline">#</a></h2>
<p>This time, the eigen values are not estimated at
training time but at prediction time.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">mlprodict.onnxrt.shape_object</span> <span class="kn">import</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/shape_object.html#mlprodict.onnxrt.shape_object.ShapeObject" title="mlprodict.onnxrt.shape_object.ShapeObject" class="sphx-glr-backref-module-mlprodict-onnxrt-shape_object sphx-glr-backref-type-py-class"><span class="n">ShapeObject</span></a>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt.ops_cpu</span> <span class="kn">import</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/_op.html#mlprodict.onnxrt.ops_cpu._op.OpRunCustom" title="mlprodict.onnxrt.ops_cpu._op.OpRunCustom" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu-_op sphx-glr-backref-type-py-class"><span class="n">OpRunCustom</span></a><span class="p">,</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/__init__.html#mlprodict.onnxrt.ops_cpu.register_operator" title="mlprodict.onnxrt.ops_cpu.register_operator" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu sphx-glr-backref-type-py-function"><span class="n">register_operator</span></a>
<span class="kn">from</span> <span class="nn">skl2onnx.algebra.onnx_ops</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">OnnxAdd</span><span class="p">,</span>
    <span class="n">OnnxCast</span><span class="p">,</span>
    <span class="n">OnnxDiv</span><span class="p">,</span>
    <span class="n">OnnxGatherElements</span><span class="p">,</span>
    <span class="n">OnnxEyeLike</span><span class="p">,</span>
    <span class="n">OnnxMatMul</span><span class="p">,</span>
    <span class="n">OnnxMul</span><span class="p">,</span>
    <span class="n">OnnxPow</span><span class="p">,</span>
    <span class="n">OnnxReduceMean</span><span class="p">,</span>
    <span class="n">OnnxShape</span><span class="p">,</span>
    <span class="n">OnnxSub</span><span class="p">,</span>
    <span class="n">OnnxTranspose</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">skl2onnx.algebra</span> <span class="kn">import</span> <span class="n">OnnxOperator</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class"><span class="n">OnnxInference</span></a>
<span class="kn">from</span> <span class="nn">pyquickhelper.helpgen.graphviz_helper</span> <span class="kn">import</span> <a href="http://www.xavierdupre.fr/app/pyquickhelper/helpsphinx/pyquickhelper/helpgen/graphviz_helper.html#pyquickhelper.helpgen.graphviz_helper.plot_graphviz" title="pyquickhelper.helpgen.graphviz_helper.plot_graphviz" class="sphx-glr-backref-module-pyquickhelper-helpgen-graphviz_helper sphx-glr-backref-type-py-function"><span class="n">plot_graphviz</span></a>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <a href="https://docs.python.org/3/library/io.html#io.BytesIO" title="io.BytesIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">BytesIO</span></a>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="kn">import</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_almost_equal.html#numpy.testing.assert_almost_equal" title="numpy.testing.assert_almost_equal" class="sphx-glr-backref-module-numpy-testing sphx-glr-backref-type-py-function"><span class="n">assert_almost_equal</span></a>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">TransformerMixin</span></a><span class="p">,</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html#sklearn.base.BaseEstimator" title="sklearn.base.BaseEstimator" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">BaseEstimator</span></a>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_iris.html#sklearn.datasets.load_iris" title="sklearn.datasets.load_iris" class="sphx-glr-backref-module-sklearn-datasets sphx-glr-backref-type-py-function"><span class="n">load_iris</span></a>
<span class="kn">from</span> <span class="nn">skl2onnx.common.data_types</span> <span class="kn">import</span> <span class="n">guess_numpy_type</span><span class="p">,</span> <span class="n">guess_proto_type</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">update_registered_converter</span>


<span class="k">class</span> <span class="nc">LiveDecorrelateTransformer</span><span class="p">(</span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">TransformerMixin</span></a><span class="p">,</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html#sklearn.base.BaseEstimator" title="sklearn.base.BaseEstimator" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">BaseEstimator</span></a><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorrelates correlated gaussian features.</span>

<span class="sd">    :param alpha: avoids non inversible matrices</span>
<span class="sd">        by adding *alpha* identity matrix</span>

<span class="sd">    *Attributes*</span>

<span class="sd">    * `self.nf_`: number of expected features</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.BaseEstimator.html#sklearn.base.BaseEstimator" title="sklearn.base.BaseEstimator" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">BaseEstimator</span></a><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">TransformerMixin</span></a><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sample_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sample_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;sample_weights != None is not implemented.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nf_</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/stdtypes.html#tuple" title="builtins.tuple" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">shape</span></a><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">):</span>
        <span class="n">mean_</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.mean.html#numpy.mean" title="numpy.mean" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X2</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a> <span class="o">-</span> <span class="n">mean_</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">X2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">X2</span> <span class="o">/</span> <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">V</span> <span class="o">+=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.identity.html#numpy.identity" title="numpy.identity" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span></a><span class="p">(</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span>
        <span class="n">L</span><span class="p">,</span> <span class="n">P</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.eig.html#numpy.linalg.eig" title="numpy.linalg.eig" class="sphx-glr-backref-module-numpy-linalg sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span></a><span class="p">(</span><span class="n">V</span><span class="p">)</span>
        <span class="n">Linv</span> <span class="o">=</span> <span class="n">L</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">diag</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.diag.html#numpy.diag" title="numpy.diag" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span></a><span class="p">(</span><span class="n">Linv</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">P</span> <span class="o">@</span> <span class="n">diag</span> <span class="o">@</span> <span class="n">P</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
        <span class="n">coef_</span> <span class="o">=</span> <span class="n">root</span>
        <span class="k">return</span> <span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a> <span class="o">-</span> <span class="n">mean_</span><span class="p">)</span> <span class="o">@</span> <span class="n">coef_</span>


<span class="k">def</span> <span class="nf">test_live_decorrelate_transformer</span><span class="p">():</span>
    <a href="https://scikit-learn.org/stable/modules/generated/sklearn.utils.Bunch.html#sklearn.utils.Bunch" title="sklearn.utils.Bunch" class="sphx-glr-backref-module-sklearn-utils sphx-glr-backref-type-py-function"><span class="n">data</span></a> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_iris.html#sklearn.datasets.load_iris" title="sklearn.datasets.load_iris" class="sphx-glr-backref-module-sklearn-datasets sphx-glr-backref-type-py-function"><span class="n">load_iris</span></a><span class="p">()</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span><span class="o">.</span><span class="n">data</span></a>

    <span class="n">dec</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">LiveDecorrelateTransformer</span></a><span class="p">()</span>
    <span class="n">dec</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">pred</span>
    <span class="n">cov</span> <span class="o">/=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_almost_equal.html#numpy.testing.assert_almost_equal" title="numpy.testing.assert_almost_equal" class="sphx-glr-backref-module-numpy-testing sphx-glr-backref-type-py-function"><span class="n">assert_almost_equal</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.identity.html#numpy.identity" title="numpy.identity" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span></a><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">cov</span><span class="p">)</span>

    <span class="n">dec</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">LiveDecorrelateTransformer</span></a><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
    <span class="n">dec</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">pred</span>
    <span class="n">cov</span> <span class="o">/=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_almost_equal.html#numpy.testing.assert_almost_equal" title="numpy.testing.assert_almost_equal" class="sphx-glr-backref-module-numpy-testing sphx-glr-backref-type-py-function"><span class="n">assert_almost_equal</span></a><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.identity.html#numpy.identity" title="numpy.identity" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span></a><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">cov</span><span class="p">)</span>

    <span class="n">st</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/io.html#io.BytesIO" title="io.BytesIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">BytesIO</span></a><span class="p">()</span>
    <a href="https://docs.python.org/3/library/pickle.html#pickle.dump" title="pickle.dump" class="sphx-glr-backref-module-pickle sphx-glr-backref-type-py-function"><span class="n">pickle</span><span class="o">.</span><span class="n">dump</span></a><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
    <span class="n">dec2</span> <span class="o">=</span> <a href="https://docs.python.org/3/library/pickle.html#pickle.load" title="pickle.load" class="sphx-glr-backref-module-pickle sphx-glr-backref-type-py-function"><span class="n">pickle</span><span class="o">.</span><span class="n">load</span></a><span class="p">(</span><a href="https://docs.python.org/3/library/io.html#io.BytesIO" title="io.BytesIO" class="sphx-glr-backref-module-io sphx-glr-backref-type-py-class"><span class="n">BytesIO</span></a><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()))</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.testing.assert_almost_equal.html#numpy.testing.assert_almost_equal" title="numpy.testing.assert_almost_equal" class="sphx-glr-backref-module-numpy-testing sphx-glr-backref-type-py-function"><span class="n">assert_almost_equal</span></a><span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">),</span> <span class="n">dec2</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">))</span>


<span class="n">test_live_decorrelate_transformer</span><span class="p">()</span>
</pre></div>
</div>
<p>Everything works as expected.</p>
</section>
<section id="extend-onnx">
<h2><a class="toc-backref" href="#id2">Extend ONNX</a><a class="headerlink" href="#extend-onnx" title="Permalink to this headline">#</a></h2>
<p>The conversion requires one operator to compute
the eigen values and vectors. The list of
<a class="reference external" href="https://github.com/onnx/onnx/blob/master/docs/Operators.md">ONNX operators</a> does not contain anything
which produces eigen values. It does not seem
efficient to implement an algorithm with existing
ONNX operators to find eigen values.
A new operator must be
added, we give it the same name <em>Eig</em> as in <a class="reference external" href="https://numpy.org/">numpy</a>.
It would take a matrix and would produce one or two outputs,
the eigen values and the eigen vectors.
Just for the exercise, a parameter specifies
to output the eigen vectors as a second output.</p>
<section id="new-onnx-operator">
<h3><a class="toc-backref" href="#id3">New ONNX operator</a><a class="headerlink" href="#new-onnx-operator" title="Permalink to this headline">#</a></h3>
<p>Any unknown operator can be
added to an ONNX graph. Operators are grouped by domain,
<cite>‘’</cite> or <cite>ai.onnx</cite> refers to matrix computation.
<cite>ai.onnx.ml</cite> refers to usual machine learning models.
New domains are officially supported by <a class="reference external" href="https://github.com/onnx/onnx">onnx</a> package.
We want to create a new operator <cite>Eig</cite> of domain <cite>onnxcustom</cite>.
It must be declared in a class, then a converter can use it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OnnxEig</span><span class="p">(</span><span class="n">OnnxOperator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Defines a custom operator not defined by ONNX</span>
<span class="sd">    specifications but in onnxruntime.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">since_version</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># last changed in this version</span>
    <span class="n">expected_inputs</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)]</span>  <span class="c1"># input names and types</span>
    <span class="n">expected_outputs</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;EigenValues&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">),</span>  <span class="c1"># output names and types</span>
                        <span class="p">(</span><span class="s1">&#39;EigenVectors&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">)]</span>
    <span class="n">input_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># only one input is allowed</span>
    <span class="n">output_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>  <span class="c1"># 1 or 2 outputs are produced</span>
    <span class="n">is_deprecated</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># obviously not deprecated</span>
    <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;onnxcustom&#39;</span>  <span class="c1"># domain, anything is ok</span>
    <span class="n">operator_name</span> <span class="o">=</span> <span class="s1">&#39;Eig&#39;</span>  <span class="c1"># operator name</span>
    <span class="n">past_version</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># empty as it is the first version</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">eigv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param X: array or OnnxOperatorMixin</span>
<span class="sd">        :param eigv: also produces the eigen vectors</span>
<span class="sd">        :param op_version: opset version</span>
<span class="sd">        :param kwargs: additional parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">OnnxOperator</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">eigv</span><span class="o">=</span><span class="n">eigv</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">op_version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="n">OnnxEig</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">eigv</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>OnnxEig(1 in) -&gt; ?
</pre></div>
</div>
<p>Now we can write the converter and
the shape calculator.</p>
</section>
<section id="shape-calculator">
<h3><a class="toc-backref" href="#id4">shape calculator</a><a class="headerlink" href="#shape-calculator" title="Permalink to this headline">#</a></h3>
<p>Nothing new here.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">live_decorrelate_transformer_shape_calculator</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">raw_operator</span>
    <span class="n">input_type</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">input_dim</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output_type</span> <span class="o">=</span> <span class="n">input_type</span><span class="p">([</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">nf_</span><span class="p">])</span>
    <span class="n">operator</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">output_type</span>
</pre></div>
</div>
</section>
<section id="converter">
<h3><a class="toc-backref" href="#id5">converter</a><a class="headerlink" href="#converter" title="Permalink to this headline">#</a></h3>
<p>The converter is using the class <cite>OnnxEig</cite>. The code
is longer than previous converters as the computation is
more complex too.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">live_decorrelate_transformer_converter</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">container</span><span class="p">):</span>
    <span class="c1"># shortcuts</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">raw_operator</span>
    <span class="n">opv</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">target_opset</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">outputs</span>

    <span class="c1"># We retrieve the unique input.</span>
    <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># We guess its type. If the operator ingests float (or double),</span>
    <span class="c1"># it outputs float (or double).</span>
    <span class="n">proto_dtype</span> <span class="o">=</span> <span class="n">guess_proto_type</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">type</span></a><span class="p">)</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">guess_numpy_type</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span><span class="o">.</span><span class="n">type</span></a><span class="p">)</span>

    <span class="c1"># Lines in comment specify the numpy computation</span>
    <span class="c1"># the ONNX code implements.</span>
    <span class="c1"># mean_ = numpy.mean(X, axis=0, keepdims=True)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">OnnxReduceMean</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">keepdims</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>

    <span class="c1"># This is trick I often use. The converter automatically</span>
    <span class="c1"># chooses a name for every output. In big graph,</span>
    <span class="c1"># it is difficult to know which operator is producing which output.</span>
    <span class="c1"># This line just tells every node must prefix its ouputs with this string.</span>
    <span class="c1"># It also applies to all inputs nodes unless this method</span>
    <span class="c1"># was called for one of these nodes.</span>
    <span class="n">mean</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

    <span class="c1"># X2 = X - mean_</span>
    <span class="n">X2</span> <span class="o">=</span> <span class="n">OnnxSub</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>

    <span class="c1"># V = X2.T @ X2 / X2.shape[0]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">OnnxGatherElements</span><span class="p">(</span>
        <span class="n">OnnxShape</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">),</span>
        <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span></a><span class="p">),</span>
        <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">Nf</span> <span class="o">=</span> <span class="n">OnnxCast</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="n">proto_dtype</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>

    <span class="c1"># Every output involved in N and Nf is prefixed by &#39;N&#39;.</span>
    <span class="n">Nf</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>

    <span class="n">V</span> <span class="o">=</span> <span class="n">OnnxDiv</span><span class="p">(</span>
        <span class="n">OnnxMatMul</span><span class="p">(</span><span class="n">OnnxTranspose</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">),</span>
                   <span class="n">X2</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">),</span>
        <span class="n">Nf</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">V</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;V1&#39;</span><span class="p">)</span>

    <span class="c1"># V += numpy.identity(V.shape[0]) * self.alpha</span>
    <span class="n">V</span> <span class="o">=</span> <span class="n">OnnxAdd</span><span class="p">(</span><span class="n">V</span><span class="p">,</span>
                <span class="n">op</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.identity.html#numpy.identity" title="numpy.identity" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">identity</span></a><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">nf_</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">V</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;V2&#39;</span><span class="p">)</span>

    <span class="c1"># L, P = numpy.linalg.eig(V)</span>
    <span class="n">LP</span> <span class="o">=</span> <span class="n">OnnxEig</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">eigv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">LP</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;LP&#39;</span><span class="p">)</span>

    <span class="c1"># Linv = L ** (-0.5)</span>
    <span class="c1"># Notation LP[0] means OnnxPow is taking the first output</span>
    <span class="c1"># of operator OnnxEig, LP[1] would mean the second one</span>
    <span class="c1"># LP is not allowed as it is ambiguous</span>
    <span class="n">Linv</span> <span class="o">=</span> <span class="n">OnnxPow</span><span class="p">(</span><span class="n">LP</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">),</span>
                   <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">Linv</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;Linv&#39;</span><span class="p">)</span>

    <span class="c1"># diag = numpy.diag(Linv)</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="n">OnnxMul</span><span class="p">(</span>
        <span class="n">OnnxEyeLike</span><span class="p">(</span>
            <a href="https://numpy.org/doc/stable/reference/generated/numpy.array.html#numpy.array" title="numpy.array" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">array</span></a><span class="p">([</span><span class="n">op</span><span class="o">.</span><span class="n">nf_</span><span class="p">,</span> <span class="n">op</span><span class="o">.</span><span class="n">nf_</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.int64" title="numpy.int64" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span></a><span class="p">),</span>
            <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">),</span>
        <span class="n">Linv</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">diag</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;diag&#39;</span><span class="p">)</span>

    <span class="c1"># root = P @ diag @ P.transpose()</span>
    <span class="n">trv</span> <span class="o">=</span> <span class="n">OnnxTranspose</span><span class="p">(</span><span class="n">LP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">coef_left</span> <span class="o">=</span> <span class="n">OnnxMatMul</span><span class="p">(</span><span class="n">LP</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">diag</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">coef_left</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;coef_left&#39;</span><span class="p">)</span>
    <span class="n">coef</span> <span class="o">=</span> <span class="n">OnnxMatMul</span><span class="p">(</span><span class="n">coef_left</span><span class="p">,</span> <span class="n">trv</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">)</span>
    <span class="n">coef</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;coef&#39;</span><span class="p">)</span>

    <span class="c1"># Same part as before.</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">OnnxMatMul</span><span class="p">(</span><span class="n">X2</span><span class="p">,</span> <span class="n">coef</span><span class="p">,</span> <span class="n">op_version</span><span class="o">=</span><span class="n">opv</span><span class="p">,</span> <span class="n">output_names</span><span class="o">=</span><span class="n">out</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">Y</span><span class="o">.</span><span class="n">set_onnx_name_prefix</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>

    <span class="c1"># The last line specifies the final output.</span>
    <span class="c1"># Every node involved in the computation is added to the ONNX</span>
    <span class="c1"># graph at this stage.</span>
    <span class="n">Y</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="runtime-for-eig">
<h3><a class="toc-backref" href="#id6">Runtime for Eig</a><a class="headerlink" href="#runtime-for-eig" title="Permalink to this headline">#</a></h3>
<p>Here comes the new part. The python runtime does not
implement any runtime for <em>Eig</em>. We need to tell the runtime
to compute eigen values and vectors every time operator <em>Eig</em>
is called. That means implementing two methods,
one to compute, one to infer the shape of the results.
The first one is mandatory, the second one can return an
empty shape if it depends on the inputs. If it is known,
the runtime may be able to optimize the computation,
by reducing allocation for example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OpEig</span><span class="p">(</span><a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/_op.html#mlprodict.onnxrt.ops_cpu._op.OpRunCustom" title="mlprodict.onnxrt.ops_cpu._op.OpRunCustom" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu-_op sphx-glr-backref-type-py-class"><span class="n">OpRunCustom</span></a><span class="p">):</span>

    <span class="n">op_name</span> <span class="o">=</span> <span class="s1">&#39;Eig&#39;</span>  <span class="c1"># operator name</span>
    <span class="n">atts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;eigv&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>  <span class="c1"># operator parameters</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_node</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="c1"># constructor, every parameter is added a member</span>
        <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/_op.html#mlprodict.onnxrt.ops_cpu._op.OpRunCustom" title="mlprodict.onnxrt.ops_cpu._op.OpRunCustom" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu-_op sphx-glr-backref-type-py-class"><span class="n">OpRunCustom</span></a><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_node</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                             <span class="n">expected_attributes</span><span class="o">=</span><a href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict" class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">OpEig</span><span class="o">.</span><span class="n">atts</span></a><span class="p">,</span>
                             <span class="o">**</span><span class="n">options</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># computation</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigv</span><span class="p">:</span>
            <span class="k">return</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.eig.html#numpy.linalg.eig" title="numpy.linalg.eig" class="sphx-glr-backref-module-numpy-linalg sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span></a><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.linalg.eigvals.html#numpy.linalg.eigvals" title="numpy.linalg.eigvals" class="sphx-glr-backref-module-numpy-linalg sphx-glr-backref-type-py-function"><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span></a><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">)</span>

    <span class="k">def</span> <span class="nf">infer_shapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># shape inference, if you don&#39;t know what to</span>
        <span class="c1"># write, just return `ShapeObject(None)`</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eigv</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/shape_object.html#mlprodict.onnxrt.shape_object.ShapeObject" title="mlprodict.onnxrt.shape_object.ShapeObject" class="sphx-glr-backref-module-mlprodict-onnxrt-shape_object sphx-glr-backref-type-py-class"><span class="n">ShapeObject</span></a><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Values&#39;</span><span class="p">),</span>
                <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/shape_object.html#mlprodict.onnxrt.shape_object.ShapeObject" title="mlprodict.onnxrt.shape_object.ShapeObject" class="sphx-glr-backref-module-mlprodict-onnxrt-shape_object sphx-glr-backref-type-py-class"><span class="n">ShapeObject</span></a><span class="p">(</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39;Vectors&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/shape_object.html#mlprodict.onnxrt.shape_object.ShapeObject" title="mlprodict.onnxrt.shape_object.ShapeObject" class="sphx-glr-backref-module-mlprodict-onnxrt-shape_object sphx-glr-backref-type-py-class"><span class="n">ShapeObject</span></a><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span> <span class="p">)</span>
</pre></div>
</div>
</section>
<section id="registration">
<h3><a class="toc-backref" href="#id7">Registration</a><a class="headerlink" href="#registration" title="Permalink to this headline">#</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update_registered_converter</span><span class="p">(</span>
    <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">LiveDecorrelateTransformer</span></a><span class="p">,</span> <span class="s2">&quot;SklearnLiveDecorrelateTransformer&quot;</span><span class="p">,</span>
    <span class="n">live_decorrelate_transformer_shape_calculator</span><span class="p">,</span>
    <span class="n">live_decorrelate_transformer_converter</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="final-example">
<h2><a class="toc-backref" href="#id8">Final example</a><a class="headerlink" href="#final-example" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="https://scikit-learn.org/stable/modules/generated/sklearn.utils.Bunch.html#sklearn.utils.Bunch" title="sklearn.utils.Bunch" class="sphx-glr-backref-module-sklearn-utils sphx-glr-backref-type-py-function"><span class="n">data</span></a> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_iris.html#sklearn.datasets.load_iris" title="sklearn.datasets.load_iris" class="sphx-glr-backref-module-sklearn-datasets sphx-glr-backref-type-py-function"><span class="n">load_iris</span></a><span class="p">()</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">data</span><span class="o">.</span><span class="n">data</span></a>

<span class="n">dec</span> <span class="o">=</span> <a href="https://scikit-learn.org/stable/modules/generated/sklearn.base.TransformerMixin.html#sklearn.base.TransformerMixin" title="sklearn.base.TransformerMixin" class="sphx-glr-backref-module-sklearn-base sphx-glr-backref-type-py-class"><span class="n">LiveDecorrelateTransformer</span></a><span class="p">()</span>
<span class="n">dec</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="p">)</span>

<span class="n">onx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span><span class="n">dec</span><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span></a><span class="p">))</span>

<a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/__init__.html#mlprodict.onnxrt.ops_cpu.register_operator" title="mlprodict.onnxrt.ops_cpu.register_operator" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu sphx-glr-backref-type-py-function"><span class="n">register_operator</span></a><span class="p">(</span><a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/ops_cpu/_op.html#mlprodict.onnxrt.ops_cpu._op.OpRunCustom" title="mlprodict.onnxrt.ops_cpu._op.OpRunCustom" class="sphx-glr-backref-module-mlprodict-onnxrt-ops_cpu-_op sphx-glr-backref-type-py-class"><span class="n">OpEig</span></a><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Eig&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">oinf</span></a> <span class="o">=</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class"><span class="n">OnnxInference</span></a><span class="p">(</span><span class="n">onx</span><span class="p">)</span>

<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exp</span></a> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span></a><span class="p">))</span>
<a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">got</span></a> <span class="o">=</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference.run" title="mlprodict.onnxrt.onnx_inference.OnnxInference.run" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-method"><span class="n">oinf</span><span class="o">.</span><span class="n">run</span></a><span class="p">({</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">X</span></a><span class="o">.</span><span class="n">astype</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float32" title="numpy.float32" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute"><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span></a><span class="p">)})[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">diff</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ufunc.html#numpy.ufunc" title="numpy.ufunc" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span></a><span class="p">(</span><span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="p">(</span><span class="n">d</span> <span class="o">/</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ufunc.html#numpy.ufunc" title="numpy.ufunc" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span></a><span class="p">(</span><span class="n">p1</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>


<span class="nb">print</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">exp</span></a><span class="p">,</span> <a href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray" class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">got</span></a><span class="p">))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>(0.0, 0.0)
</pre></div>
</div>
<p>It works!</p>
</section>
<section id="final-graph">
<h2><a class="toc-backref" href="#id9">Final graph</a><a class="headerlink" href="#final-graph" title="Permalink to this headline">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">oinf</span></a> <span class="o">=</span> <a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class"><span class="n">OnnxInference</span></a><span class="p">(</span><span class="n">onx</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <a href="http://www.xavierdupre.fr/app/pyquickhelper/helpsphinx/pyquickhelper/helpgen/graphviz_helper.html#pyquickhelper.helpgen.graphviz_helper.plot_graphviz" title="pyquickhelper.helpgen.graphviz_helper.plot_graphviz" class="sphx-glr-backref-module-pyquickhelper-helpgen-graphviz_helper sphx-glr-backref-type-py-function"><span class="n">plot_graphviz</span></a><span class="p">(</span><a href="http://www.xavierdupre.fr/app/mlprodict/helpsphinx/mlprodict/onnxrt/onnx_inference.html#mlprodict.onnxrt.onnx_inference.OnnxInference" title="mlprodict.onnxrt.onnx_inference.OnnxInference" class="sphx-glr-backref-module-mlprodict-onnxrt-onnx_inference sphx-glr-backref-type-py-class sphx-glr-backref-instance"><span class="n">oinf</span></a><span class="o">.</span><span class="n">to_dot</span><span class="p">())</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.get_xaxis.html#matplotlib.axes.Axes.get_xaxis" title="matplotlib.axes.Axes.get_xaxis" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span></a><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.get_yaxis.html#matplotlib.axes.Axes.get_yaxis" title="matplotlib.axes.Axes.get_yaxis" class="sphx-glr-backref-module-matplotlib-axes sphx-glr-backref-type-py-method"><span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span></a><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img src="../_images/sphx_glr_plot_pextend_python_runtime_001.png" srcset="../_images/sphx_glr_plot_pextend_python_runtime_001.png" alt="plot pextend python runtime" class = "sphx-glr-single-img"/><p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.380 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorial-plot-pextend-python-runtime-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/onnx/onnx.ai/sklearn-onnx//master?filepath=auto_examples/auto_tutorial/plot_pextend_python_runtime.ipynb"><img alt="Launch binder" src="../_images/binder_badge_logo1.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/2f8d04b47600766e780eb9c1b5b5a68d/plot_pextend_python_runtime.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_pextend_python_runtime.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/1e0097aeb4f54b635ceba842f3e6889a/plot_pextend_python_runtime.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_pextend_python_runtime.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


              </div>
              
              
              <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../tutorial_3_new_operator.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Extend ONNX, extend runtime</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="plot_qextend_onnxruntime.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Fast runtime with onnxruntime</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
              
          </main>
          

      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>
<footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2018-2022, Microsoft.<br>
</p>
    </div>
    
    <div class="footer-item">
      <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.5.0.<br>
</p>
    </div>
    
  </div>
</footer>
  </body>
</html>