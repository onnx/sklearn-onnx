
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Black list operators when converting &#8212; sklearn-onnx 1.9.1.dev documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/readable.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/gallery-rendered-html.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Issues when switching to float" href="plot_ebegin_float_double.html" />
    <link rel="prev" title="One model, many possible conversions with options" href="plot_dbegin_options.html" />
   
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head><body>
  
  

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="plot_ebegin_float_double.html" title="Issues when switching to float"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="plot_dbegin_options.html" title="One model, many possible conversions with options"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">sklearn-onnx 1.9.1.dev documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index_tutorial.html" >Tutorial</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../tutorial_1_simple.html" accesskey="U">The easy case</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Black list operators when converting</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-auto-tutorial-plot-dbegin-options-list-py"><span class="std std-ref">here</span></a>
to download the full example code or to run this example in your browser via Binder</p>
</div>
<section class="sphx-glr-example-title" id="black-list-operators-when-converting">
<span id="sphx-glr-auto-tutorial-plot-dbegin-options-list-py"></span><h1>Black list operators when converting<a class="headerlink" href="#black-list-operators-when-converting" title="Permalink to this headline">¶</a></h1>
<p id="index-0">Some runtimes do not implement a runtime for every
available operator in ONNX. The converter does not know
that but it is possible to black some operators. Most of
the converters do not change their behaviour, they fail
if they use a black listed operator, a couple of them
produces a different ONNX graph.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#gaussianmixture" id="id1">GaussianMixture</a></p></li>
<li><p><a class="reference internal" href="#default-conversion" id="id2">Default conversion</a></p></li>
<li><p><a class="reference internal" href="#conversion-without-reducelogsumexp" id="id3">Conversion without ReduceLogSumExp</a></p></li>
<li><p><a class="reference internal" href="#processing-time" id="id4">Processing time</a></p></li>
<li><p><a class="reference internal" href="#if-the-converter-cannot-convert-without" id="id5">If the converter cannot convert without…</a></p></li>
</ul>
</div>
<section id="gaussianmixture">
<h2><a class="toc-backref" href="#id1">GaussianMixture</a><a class="headerlink" href="#gaussianmixture" title="Permalink to this headline">¶</a></h2>
<p>The first converter to change its behaviour depending on a black list
of operators is for model <em>GaussianMixture</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyquickhelper.helpgen.graphviz_helper</span> <span class="kn">import</span> <span class="n">plot_graphviz</span>
<span class="kn">from</span> <span class="nn">mlprodict.onnxrt</span> <span class="kn">import</span> <span class="n">OnnxInference</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">onnxruntime</span> <span class="kn">import</span> <span class="n">InferenceSession</span>
<span class="kn">from</span> <span class="nn">sklearn.mixture</span> <span class="kn">import</span> <span class="n">GaussianMixture</span>
<span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">load_iris</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">skl2onnx</span> <span class="kn">import</span> <span class="n">to_onnx</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_iris</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">GaussianMixture</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>C:\Python395_x64\lib\site-packages\sklearn\cluster\_kmeans.py:881: UserWarning: KMeans is known to have a memory leak on Windows with MKL, when there are less chunks than available threads. You can avoid it by setting the environment variable OMP_NUM_THREADS=1.
  warnings.warn(

GaussianMixture()
</pre></div>
</div>
</section>
<section id="default-conversion">
<h2><a class="toc-backref" href="#id2">Default conversion</a><a class="headerlink" href="#default-conversion" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">model</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;score_samples&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
    <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">sess</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_onnx</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">xt</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">xt</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt</span><span class="p">})[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[-4.63413544 -1.82908431 -2.74063698 -5.7397913  -3.38552462]
[[-4.634138 ]
 [-1.8290834]
 [-2.7406368]
 [-5.739794 ]
 [-3.3855247]]
</pre></div>
</div>
<p>Display the ONNX graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_onnx</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_graphviz</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">to_dot</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="plot dbegin options list" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_dbegin_options_list_001.png" />
</section>
<section id="conversion-without-reducelogsumexp">
<h2><a class="toc-backref" href="#id3">Conversion without ReduceLogSumExp</a><a class="headerlink" href="#conversion-without-reducelogsumexp" title="Permalink to this headline">¶</a></h2>
<p>Parameter <em>black_op</em> is used to tell the converter
not to use this operator. Let’s see what the converter
produces in that case.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model_onnx2</span> <span class="o">=</span> <span class="n">to_onnx</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">model</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;score_samples&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
    <span class="n">black_op</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ReduceLogSumExp&#39;</span><span class="p">},</span>
    <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">sess2</span> <span class="o">=</span> <span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_onnx2</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>

<span class="n">xt</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">xt</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sess2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="n">xt</span><span class="p">})[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>[-4.63413544 -1.82908431 -2.74063698 -5.7397913  -3.38552462]
[[-4.634138 ]
 [-1.8290834]
 [-2.7406373]
 [-5.739794 ]
 [-3.3855252]]
</pre></div>
</div>
<p>Display the ONNX graph.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">oinf</span> <span class="o">=</span> <span class="n">OnnxInference</span><span class="p">(</span><span class="n">model_onnx2</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plot_graphviz</span><span class="p">(</span><span class="n">oinf</span><span class="o">.</span><span class="n">to_dot</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<img alt="plot dbegin options list" class="sphx-glr-single-img" src="../_images/sphx_glr_plot_dbegin_options_list_002.png" />
</section>
<section id="processing-time">
<h2><a class="toc-backref" href="#id4">Processing time</a><a class="headerlink" href="#processing-time" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">timeit</span><span class="p">(</span><span class="n">stmt</span><span class="o">=</span><span class="s2">&quot;sess.run(None, {&#39;X&#39;: xt})&quot;</span><span class="p">,</span>
             <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sess&#39;</span><span class="p">:</span> <span class="n">sess</span><span class="p">,</span> <span class="s1">&#39;xt&#39;</span><span class="p">:</span> <span class="n">xt</span><span class="p">}))</span>

<span class="nb">print</span><span class="p">(</span><span class="n">timeit</span><span class="p">(</span><span class="n">stmt</span><span class="o">=</span><span class="s2">&quot;sess2.run(None, {&#39;X&#39;: xt})&quot;</span><span class="p">,</span>
             <span class="n">number</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sess2&#39;</span><span class="p">:</span> <span class="n">sess2</span><span class="p">,</span> <span class="s1">&#39;xt&#39;</span><span class="p">:</span> <span class="n">xt</span><span class="p">}))</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>0.4192585000000122
0.4977758999999935
</pre></div>
</div>
<p>The model using ReduceLogSumExp is much faster.</p>
</section>
<section id="if-the-converter-cannot-convert-without">
<h2><a class="toc-backref" href="#id5">If the converter cannot convert without…</a><a class="headerlink" href="#if-the-converter-cannot-convert-without" title="Permalink to this headline">¶</a></h2>
<p>Many converters do not consider the white and black lists
of operators. If a converter fails to convert without using
a blacklisted operator (or only whitelisted operators),
<em>skl2onnx</em> raises an error.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">to_onnx</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">X_train</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="nb">id</span><span class="p">(</span><span class="n">model</span><span class="p">):</span> <span class="p">{</span><span class="s1">&#39;score_samples&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}},</span>
        <span class="n">black_op</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ReduceLogSumExp&#39;</span><span class="p">,</span> <span class="s1">&#39;Add&#39;</span><span class="p">},</span>
        <span class="n">target_opset</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p class="sphx-glr-script-out">Out:</p>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Error: Operator &#39;Add&#39; is black listed.
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  2.315 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorial-plot-dbegin-options-list-py">
<div class="binder-badge docutils container">
<a class="reference external image-reference" href="https://mybinder.org/v2/gh/onnx/sklearn-onnx/master?filepath=notebooks/auto_tutorial/plot_dbegin_options_list.ipynb"><img alt="Launch binder" src="../_images/binder_badge_logo1.svg" width="150px" /></a>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/186ee738e3c4a97e498a4b21c416aa4e/plot_dbegin_options_list.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_dbegin_options_list.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/4fb830ec47c83319dff3227932da0ad5/plot_dbegin_options_list.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_dbegin_options_list.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/logo_main.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Black list operators when converting</a><ul>
<li><a class="reference internal" href="#gaussianmixture">GaussianMixture</a></li>
<li><a class="reference internal" href="#default-conversion">Default conversion</a></li>
<li><a class="reference internal" href="#conversion-without-reducelogsumexp">Conversion without ReduceLogSumExp</a></li>
<li><a class="reference internal" href="#processing-time">Processing time</a></li>
<li><a class="reference internal" href="#if-the-converter-cannot-convert-without">If the converter cannot convert without…</a></li>
</ul>
</li>
</ul>
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation index</a><ul>
  <li><a href="../index_tutorial.html">Tutorial</a><ul>
  <li><a href="../tutorial_1_simple.html">The easy case</a><ul>
      <li>Previous: <a href="plot_dbegin_options.html" title="previous chapter">One model, many possible conversions with options</a></li>
      <li>Next: <a href="plot_ebegin_float_double.html" title="next chapter">Issues when switching to float</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/auto_tutorial/plot_dbegin_options_list.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  <div class="footer">
    &copy; Copyright 2018-2021, Microsoft.
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.1.0.
  </div>
  
  </body>
</html>